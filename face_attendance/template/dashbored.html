{% extends "base.html" %}
{% block content %}
<h1>Dashboard â€” {{ today.strftime("%A, %b %d") if today is defined else "" }}</h1>

<div class="cards">
  <div class="card">
    <div class="k">Total Users</div>
    <div class="v">{{ metrics.total_users if metrics is defined else 0 }}</div>
  </div>
  <div class="card">
    <div class="k">Present</div>
    <div class="v">{{ metrics.present_today if metrics is defined else 0 }}</div>
  </div>
  <div class="card">
    <div class="k">Absent</div>
    <div class="v">{{ metrics.absent_today if metrics is defined else 0 }}</div>
  </div>
  <div class="card">
    <div class="k">Late</div>
    <div class="v">{{ metrics.late_today if metrics is defined else 0 }}</div>
  </div>
</div>

<h3>Late Today</h3>
<ul>
  {% if metrics is defined and metrics.late_employees %}
    {% for e in metrics.late_employees %}
      <li><strong>{{ e.name }}</strong> at {{ e.time }}</li>
    {% endfor %}
  {% else %}
    <li>No late arrivals recorded yet.</li>
  {% endif %}
</ul>

<h3>Absent Today</h3>
<ul>
  {% if metrics is defined and metrics.absent_employees %}
    {% for n in metrics.absent_employees %}
      <li>{{ n }}</li>
    {% endfor %}
  {% else %}
    <li>Everyone present ðŸŽ‰</li>
  {% endif %}
</ul>

<h3>Weekly Overview</h3>
<div style="height:260px">
  <canvas id="weeklyChart"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Put Jinja data as pure JSON so editors are happy -->
<script id="weekly-data" type="application/json">
  {{
    {
      "labels":  (metrics.weekly_labels  if metrics is defined else []),
      "present": (metrics.weekly_present if metrics is defined else []),
      "absent":  (metrics.weekly_absent  if metrics is defined else []),
      "late":    (metrics.weekly_late    if metrics is defined else [])
    } | tojson
  }}
</script>

<script>
(() => {
  const el = document.getElementById('weekly-data');
  if (!el) return;

  let data;
  try { data = JSON.parse(el.textContent); } catch { return; }

  const labels      = Array.isArray(data.labels)  ? data.labels  : [];
  const presentData = Array.isArray(data.present) ? data.present : [];
  const absentData  = Array.isArray(data.absent)  ? data.absent  : [];
  const lateData    = Array.isArray(data.late)    ? data.late    : [];

  if (!labels.length) return; // nothing to plot

  const ctx = document.getElementById('weeklyChart');
  if (!ctx) return;

  new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Present', data: presentData },
        { label: 'Absent',  data: absentData  },
        { label: 'Late',    data: lateData    },
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { position: 'bottom' } },
      scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
    }
  });
})();
</script>
